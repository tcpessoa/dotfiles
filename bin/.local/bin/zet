#!/bin/bash

WORK_VAULT_DIR="$HOME/Library/CloudStorage/OneDrive-G42/Obsidian Vault"
VAULT_DIR="$HOME/code/my-vault/"

get_filename() {
    read -p "Enter a filename: " filename
    echo "$(date +%Y%m%d)-$filename"
}

create_note() {
    local target_dir="$1"
    local filename="$2"
    local file_path="$target_dir/$filename.md"
    
    mkdir -p "$target_dir" || { echo "Failed to create directory: $target_dir"; exit 1; }
    
    cat > "$file_path" << EOF
---
created: $(date +"%Y-%m-%d %H:%M")
---
# ${filename#*-}


EOF
    
    # Position cursor on the empty line after the title
    nvim "+4" "+normal j" "+startinsert" "$file_path"
}

determine_vault() {
    if [[ "$1" == "-p" ]]; then
        echo "$VAULT_DIR/0-Inbox"
    elif [[ "$(hostname)" == *"LT4062442416"* ]] || [[ -n "$WORK_ENV" ]]; then
        echo "$WORK_VAULT_DIR/0-Inbox"
    else
        echo "$WORK_VAULT_DIR/0-Inbox"
    fi
}

main() {
    local target_vault
    local filename
    local date_prefix=$(date +%Y%m%d)
    
    if [[ "$1" == "-p" ]]; then
        target_vault=$(determine_vault "-p")
        shift
    else
        target_vault=$(determine_vault)
    fi
    
    if [[ ! -d "$(dirname "$target_vault")" ]]; then
        echo "Error: Vault directory not found: $(dirname "$target_vault")"
        exit 1
    fi
    
    case $# in
        0)  filename=$(get_filename)
            ;;
        1)  filename="${date_prefix}-$1"
            ;;
        *)  echo "Usage: $(basename "$0") [-p] [filename]"
            echo "  -p: Use personal vault"
            echo "  filename: Note name (optional, will prompt if not provided)"
            echo "Example: $(basename "$0") my-new-note"
            echo "  creates: ${date_prefix}-my-new-note.md"
            exit 1
            ;;
    esac
    
    if [[ ! "${filename#*-}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo "Error: Filename can only contain letters, numbers, underscores, and hyphens"
        exit 1
    fi
    
    create_note "$target_vault" "$filename"
}

main "$@"
