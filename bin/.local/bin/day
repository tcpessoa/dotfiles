#!/bin/bash

WORK_VAULT_DIR="$HOME/Library/CloudStorage/OneDrive-G42/Obsidian Vault"
VAULT_DIR="$HOME/code/my-vault/"

determine_vault_type() {
    if [[ "$1" == "-p" ]]; then
        echo "personal"
    elif [[ "$(hostname)" == *"LT4062442416"* ]] || [[ -n "$WORK_ENV" ]]; then
        echo "work"
    else
        echo "work"
    fi
}

create_daily_note() {
    local vault_type="$1"
    local daily_dir
    local template_path
    
    case "$vault_type" in
        "work")
            daily_dir="$WORK_VAULT_DIR/daily"
            template_path="$WORK_VAULT_DIR/templates/daily-v.md"
            ;;
        "personal")
            daily_dir="$VAULT_DIR/00-zet/daily"
            template_path="$VAULT_DIR/templates/daily.md"
            ;;
        *)
            echo "Error: Invalid vault type. Use 'work' or 'personal'"
            exit 1
            ;;
    esac
    
    mkdir -p "$daily_dir"
    
    local today=$(date +"%Y-%m-%d")
    local yesterday=$(date -v-1d +"%y-%m-%d")
    local tomorrow=$(date -v+1d +"%y-%m-%d")
    local filename="$daily_dir/$today.md"
    
    if [[ -f "$filename" ]]; then
        echo "Today's note already exists in $vault_type vault. Opening existing file."
    else
        if [[ -f "$template_path" ]]; then
            eval "cat << EOF
$(cat "$template_path")
EOF" > "$filename"
            echo "Created new daily note for $today"
        else
            echo "Error: Template not found at $template_path"
            exit 1
        fi
    fi
    
    nvim "+ normal ggzzi" "$filename"
}

main() {
    local vault_type
    
    if [[ ! -d "$WORK_VAULT_DIR" && ! -d "$VAULT_DIR" ]]; then
        echo "Error: Neither work nor personal vault directories found"
        exit 1
    fi
    
    if [[ "$1" == "-p" ]]; then
        vault_type="personal"
        shift
    else
        vault_type=$(determine_vault_type)
    fi
    
    if [[ "$vault_type" == "work" && ! -d "$WORK_VAULT_DIR" ]]; then
        echo "Error: Work vault directory not found"
        exit 1
    fi
    
    if [[ "$vault_type" == "personal" && ! -d "$VAULT_DIR" ]]; then
        echo "Error: Personal vault directory not found"
        exit 1
    fi
    
    case $# in
        0)  ;;
        *)  echo "Usage: $(basename "$0") [-p]"
            echo "  -p: Use personal vault"
            echo "  Default: Uses work vault based on hostname or WORK_ENV"
            exit 1
            ;;
    esac
    
    create_daily_note "$vault_type"
}

main "$@"
